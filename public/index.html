<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Trends</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìà</text></svg>">
</head>
<body class="bg-gray-900 text-white min-h-screen">
  <div id="app" class="max-w-6xl mx-auto p-4">

    <!-- Header -->
    <header class="flex justify-between items-center py-4 mb-6 border-b border-gray-800">
      <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
        Product Trends
      </h1>
      <div class="flex items-center gap-4">
        <span id="credits" class="text-sm text-gray-400"></span>
        <button onclick="openSettings()" class="hover:bg-gray-800 p-2 rounded-lg">‚öôÔ∏è</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="flex gap-2 mb-4 flex-wrap">
      <button onclick="setTab('tiktok')" data-tab="tiktok" class="tab-btn px-4 py-2 rounded-lg bg-blue-600">üéµ TikTok</button>
      <button onclick="setTab('shop')" data-tab="shop" class="tab-btn px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700">üõí TikTok Shop</button>
      <button onclick="setTab('instagram')" data-tab="instagram" class="tab-btn px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700">üì∏ Instagram</button>
    </div>

    <!-- Search -->
    <div class="flex gap-2 mb-6">
      <input
        type="text"
        id="search"
        placeholder="Search products, trends, keywords..."
        class="flex-1 bg-gray-800 px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        onkeypress="if(event.key==='Enter')doSearch()"
      >
      <button onclick="doSearch()" class="bg-blue-600 hover:bg-blue-500 px-6 py-3 rounded-lg font-medium">
        Search
      </button>
    </div>

    <!-- Error -->
    <div id="error" class="hidden bg-red-900/50 border border-red-500 text-red-300 p-4 rounded-lg mb-4"></div>

    <!-- Loading -->
    <div id="loading" class="hidden text-center py-20">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
      <p class="mt-4 text-gray-400">Loading...</p>
    </div>

    <!-- Results Grid -->
    <div id="results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>

    <!-- Empty State -->
    <div id="empty" class="text-center py-20 text-gray-500">
      <p class="text-5xl mb-4">üîç</p>
      <p>Enter a keyword to search for trending products</p>
    </div>

    <!-- Debug Log -->
    <details class="mt-8">
      <summary class="text-gray-500 text-sm cursor-pointer">Debug Log</summary>
      <pre id="log" class="mt-2 bg-gray-800 p-4 rounded-lg text-xs text-gray-400 max-h-40 overflow-auto"></pre>
    </details>
  </div>

  <!-- Settings Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl p-6 w-full max-w-md mx-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">Settings</h2>
        <button onclick="closeSettings()" class="text-2xl hover:text-gray-400">&times;</button>
      </div>
      <div class="space-y-4">
        <div>
          <label class="block text-sm text-gray-400 mb-1">ScrapeCreators API Key</label>
          <input type="text" id="apiKey" class="w-full bg-gray-700 px-4 py-2 rounded-lg" placeholder="Your API key">
          <p class="text-xs text-gray-500 mt-1">Get your key at <a href="https://scrapecreators.com" target="_blank" class="text-blue-400">scrapecreators.com</a></p>
        </div>
        <div id="testResult"></div>
        <div class="flex gap-2">
          <button onclick="testKey()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-2 rounded-lg">Test</button>
          <button onclick="saveKey()" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded-lg">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentTab = 'tiktok';

    // Logging
    function log(msg) {
      console.log(msg);
      const el = document.getElementById('log');
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + el.textContent;
    }

    // UI helpers
    function show(id) { document.getElementById(id).classList.remove('hidden'); }
    function hide(id) { document.getElementById(id).classList.add('hidden'); }

    // Settings
    function openSettings() { show('modal'); }
    function closeSettings() { hide('modal'); }

    async function loadConfig() {
      const res = await fetch('/api/config');
      const data = await res.json();
      document.getElementById('apiKey').value = data.apiKey || '';
      if (data.hasKey) log('API key loaded');
    }

    async function saveKey() {
      const key = document.getElementById('apiKey').value;
      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ apiKey: key })
      });
      log('API key saved');
      closeSettings();
    }

    async function testKey() {
      document.getElementById('testResult').innerHTML = '<p class="text-yellow-400">Testing...</p>';
      await saveKey();
      const res = await fetch('/api/test');
      const data = await res.json();
      if (data.success) {
        document.getElementById('testResult').innerHTML = `<p class="text-green-400">‚úì Connected! Credits: ${data.credits}</p>`;
        document.getElementById('credits').textContent = `Credits: ${data.credits}`;
      } else {
        document.getElementById('testResult').innerHTML = `<p class="text-red-400">‚úó ${data.error}</p>`;
      }
      openSettings(); // Reopen after save
    }

    // Tabs
    function setTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('bg-blue-600', btn.dataset.tab === tab);
        btn.classList.toggle('bg-gray-800', btn.dataset.tab !== tab);
      });
      log(`Tab: ${tab}`);
    }

    // Search
    async function doSearch() {
      const query = document.getElementById('search').value.trim();
      if (!query) return;

      hide('error');
      hide('empty');
      hide('results');
      show('loading');
      log(`Searching "${query}" on ${currentTab}`);

      let url;
      if (currentTab === 'tiktok') url = `/api/tiktok/search?q=${encodeURIComponent(query)}`;
      if (currentTab === 'shop') url = `/api/tiktok/shop?q=${encodeURIComponent(query)}`;
      if (currentTab === 'instagram') url = `/api/instagram/reels?q=${encodeURIComponent(query)}`;

      try {
        const res = await fetch(url);
        const json = await res.json();
        hide('loading');

        if (!json.success) {
          document.getElementById('error').textContent = json.error;
          show('error');
          return;
        }

        // Update credits
        if (json.data?.credits_remaining) {
          document.getElementById('credits').textContent = `Credits: ${json.data.credits_remaining}`;
        }

        renderResults(json.data);
      } catch (e) {
        hide('loading');
        document.getElementById('error').textContent = e.message;
        show('error');
        log(`Error: ${e.message}`);
      }
    }

    // Render results
    function renderResults(data) {
      log('Data keys: ' + Object.keys(data).join(', '));

      // Get items array from various possible locations
      let items = data.search_item_list || data.products || data.reels || data.data || [];

      // Extract aweme_info if present
      if (items[0]?.aweme_info) {
        items = items.map(i => i.aweme_info);
      }

      log(`Rendering ${items.length} items`);

      if (items.length === 0) {
        show('empty');
        return;
      }

      const container = document.getElementById('results');
      container.innerHTML = items.slice(0, 24).map(item => {
        // Handle different data structures
        const title = item.desc || item.title || item.product_name || 'No title';
        const image = item.video?.cover?.url_list?.[0] ||
                      item.video?.origin_cover?.url_list?.[0] ||
                      item.cover ||
                      item.image?.url_list?.[0] ||
                      item.product_img_url || '';
        const views = item.statistics?.play_count || 0;
        const likes = item.statistics?.digg_count || 0;
        const author = item.author?.nickname || item.author?.unique_id || '';
        const sold = item.sold_count || item.sales || 0;
        const price = item.price ? `$${(item.price / 100).toFixed(2)}` :
                      item.min_price ? `$${item.min_price}` : '';

        return `
          <div class="bg-gray-800 rounded-xl overflow-hidden hover:bg-gray-750 transition">
            ${image ?
              `<img src="${image}" class="w-full h-40 object-cover" onerror="this.parentElement.innerHTML='<div class=\\'h-40 bg-gray-700 flex items-center justify-center text-gray-500\\'>No image</div>'+this.parentElement.innerHTML.split('</img>')[1]">` :
              '<div class="h-40 bg-gray-700 flex items-center justify-center text-gray-500">No image</div>'
            }
            <div class="p-3">
              <p class="text-sm line-clamp-2 mb-2">${escapeHtml(title.substring(0, 100))}</p>
              ${author ? `<p class="text-xs text-gray-500 mb-2">@${escapeHtml(author)}</p>` : ''}
              <div class="flex justify-between text-xs text-gray-400">
                ${views ? `<span>‚ñ∂Ô∏è ${formatNum(views)}</span>` : ''}
                ${likes ? `<span>‚ù§Ô∏è ${formatNum(likes)}</span>` : ''}
                ${sold ? `<span>üî• ${formatNum(sold)} sold</span>` : ''}
                ${price ? `<span class="text-green-400 font-bold">${price}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');

      show('results');
    }

    // Helpers
    function formatNum(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return n.toString();
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
    }

    // Init
    loadConfig();
    log('App loaded');
  </script>
</body>
</html>
